#!/usr/bin/env ksh
# *****************************COPYRIGHT******************************
# (C) Crown copyright Met Office. All rights reserved.
# For further details please refer to the file COPYRIGHT.txt
# which you should have received as part of this distribution.
# *****************************COPYRIGHT******************************
#-----------------------------------------------------------------------
#
#  Script: UMScr_Time2Days
#
#  Purpose: Convert the date to seconds since calendar zero.
#
#  Programming Standard: UMDP 3 version unknown
#
#  External documentation:
#           UMDP-C2
#
#  Code Owner: Please refer to the UM file CodeOwners.txt
#  This file belongs in section: Rose scripts
#
#----------------------------------------------------------------------
#
#   Called by: qsnemosetup, qscicesetup
#   Calls:   
#
#  Imports:
#    year     - The year of the input date.
#    month    - Month of the year
#    day      - Day of the month
#    calendar - Type of calendar being used [360|365|gregorian]
#
#  Exports:
#    days_since_calz - The script returns the number of days since 
#                      calendar zero via standard out.
#
#  Local Variables:
#
#   daycal           - An array of the "day of the year" for the start 
#                      of each month
#   days_per_4c      - Number of day in 4 centuries
#   days_per_c       - Number of days in a century
#   days_per_4y      - Number of days in 4 years
#   days_per_y       - Number of days in a year.
#   years_since_calz - Number of years to calendar zero 
#

# Set script name
this=UMScr_Time2Days

# Arguments
year=$1
month=$2
day=$3
calendar=$4

# Internal variables 
days_since_calz=0
years_since_calz=0

# Constants
secday=86400
days_per_4c=146097
days_per_c=36524
days_per_4y=1461
days_per_y=365

if [[ $calendar = "360" ]]; then
    (( days_since_calz = 360*year + 30*(month-1) + day - 1 ))
  
elif [[ $calendar = "365" ]]; then

    set -A daycal 999 0 31 59 90 120 151 181 212 243 273 304 334

    (( days_since_calz = 365*year + daycal[month] + day - 1 ))

elif [ $calendar = "gregorian" ]; then

    # Check if it is a leap year.
    if [ $((year%400)) -eq 0 ]; then
	leap_year=true
    elif [ $((year%100)) -eq 0 ]; then
	leap_year=false
    elif [ $((year%4)) -eq 0 ]; then
	leap_year=true
    else
	leap_year=false
    fi


    # Set the correct calendar
    if [ $leap_year = true ]; then
	set -A daycal 999 0 31 60 91 121 152 182 213 244 274 305 335
    else
	set -A daycal 999 0 31 59 90 120 151 181 212 243 273 304 334
    fi


    # Add on the days from this year
    (( days_since_calz = daycal[month] + day - 1 ))

    # Subtract a year because we only want to count whole years
    (( years_since_calz = year - 1 ))

    # Add days from preceeding years. !!Beware integer division!!
    # Count number of 4 centuries first.
    (( days_since_calz = days_since_calz + days_per_4c*(years_since_calz/400) ))
    (( years_since_calz = years_since_calz - 400*(years_since_calz/400) ))

    # Count number of centuries left
    (( days_since_calz = days_since_calz + days_per_c*(years_since_calz/100) ))
    (( years_since_calz = years_since_calz - 100*(years_since_calz/100) ))

    # Count number of 4 year periods left
    (( days_since_calz = days_since_calz + days_per_4y*(years_since_calz/4) ))
    (( years_since_calz = years_since_calz - 4*(years_since_calz/4) ))

    # Count the remaining years.
    (( days_since_calz = days_since_calz + years_since_calz*days_per_y ))

else
    echo "${this}: ERROR - Unrecognised calendar type."
    return 1

fi

# echo the number of days since calendar zero to standard out.
echo $days_since_calz

# Return with success code
return 0
    

